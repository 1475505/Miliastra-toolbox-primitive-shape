# Shaper V3 技术方案

## 概述

Shaper 是一个**轮廓描边工具**，用基础图元（椭圆/矩形）沿图片主体轮廓进行"串珠"式拼接拟合。核心目标：

- 只描边轮廓，不填充内部
- 图元不超出轮廓（向内侧贴合）
- 图元尽可能大，无明显间隙
- 根据局部曲率自动选择图元类型和大小

## 使用方式

### 安装依赖

```bash
pip install opencv-python numpy shapely scipy
```

### 运行

```bash
python final_shaper.py <图片路径> [选项]
```

### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `image_path` | `genshin.png` | 输入图片路径（支持 PNG/JPG/BMP/WebP） |
| `--min_size` | `6` | 最小图元尺寸（像素） |
| `--max_size` | `30` | 最大图元尺寸（像素） |
| `--spacing` | `0.9` | 间距系数（0.9 = 10% 重叠，越小重叠越多） |
| `-p, --precision` | `0.3` | 精度 0.0~1.0（低=偏好矩形+大拉伸，高=偏好椭圆+精细贴合） |

### 使用示例

```bash
# 默认参数
python final_shaper.py genshin.png

# 高精度模式（更多椭圆，贴合更精细）
python final_shaper.py genshin.png -p 0.8

# 大图元粗拟合
python final_shaper.py genshin.png --min_size 10 --max_size 50 -p 0.2

# 密集小图元
python final_shaper.py genshin.png --min_size 3 --max_size 15 --spacing 0.85
```

### 输出文件

| 文件 | 说明 |
|------|------|
| `result_A_shapes_only.png` | 仅图元拼接效果图（BGRA，透明背景） |
| `result_B_overlay.png` | 图元拼接与原图叠加对比图 |
| `result_C_data.json` | 所有图元的坐标、尺寸、旋转角度等结构化数据 |

### 输出 JSON 格式

```jsonc
{
  "image_center": { "x": 155.0, "y": 122.0 },   // 图片中心坐标 (D)
  "image_size": { "width": 310, "height": 244 },
  "config": { ... },
  "elements_count": 289,
  "elements": [
    {
      "id": "0_3",
      "type": "ellipse",                          // 或 "rectangle"
      "center": { "x": 74.5, "y": 141.5 },       // 绝对坐标
      "relative_position": { "x": -80.5, "y": 19.5 }, // 相对图片中心 (C)
      "rotation": 45.0,                           // 旋转角度（度）
      "size": { "rx": 12.5, "ry": 8.0 }           // 椭圆半轴
      // 或 "size": { "width": 20.0, "height": 10.0 } // 矩形宽高
    }
    // ...
  ]
}
```

---

## 技术架构

```
输入图片
  │
  ▼
┌─────────────────────────────────────────────┐
│  图像预处理                                    │
│  ├─ Alpha/灰度 → 二值 Mask                     │
│  ├─ 形态学闭运算（去噪）                         │
│  ├─ Distance Transform（距离场）                │
│  └─ findContours（轮廓提取, RETR_TREE）          │
└──────────────┬──────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────┐
│  P0: 曲率分段 + 局部最优拟合                     │
│  ├─ A. 曲率计算（高斯平滑微分）                   │
│  ├─ B. 曲率三档分类 + 短段合并                    │
│  ├─ C. 沿轮廓游走，每个停靠点：                    │
│  │   ├─ 二分查找最大内切半径（距离场）              │
│  │   ├─ 根据分段类型尝试拉伸为椭圆/矩形             │
│  │   ├─ Shapely 包含性检验                       │
│  │   └─ 选择面积最大的候选图元                     │
│  └─ D. 步进到下一个停靠点                         │
└──────────────┬──────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────┐
│  P2: 后处理优化                                 │
│  ├─ A. 渲染覆盖掩码 → 沿轮廓采样检测间隙           │
│  ├─ B. 间隙填充（多轮迭代）                       │
│  └─ C. 图元扩展（贪心增大长轴）                    │
└──────────────┬──────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────┐
│  输出                                          │
│  ├─ result_A_shapes_only.png                   │
│  ├─ result_B_overlay.png                       │
│  └─ result_C_data.json                         │
└─────────────────────────────────────────────┘
```

---

## 核心算法详解

### P0-A: 曲率计算

对闭合轮廓点集 $(x_i, y_i)$ 进行高斯平滑后，用参数微分公式计算无符号曲率：

$$
\kappa = \frac{|x'y'' - y'x''|}{(x'^2 + y'^2)^{3/2}}
$$

- 首尾拼接处理闭合边界（pad = 3σ 个点）
- 两级平滑：σ=5.0 预平滑坐标 + σ=2.0 后平滑曲率
- 复杂度 O(N)

### P0-B: 曲率分段

将曲率值分为三档：

| 分类 | 曲率阈值 | 含义 | 图元策略 |
|------|---------|------|---------|
| `straight` | κ < 0.012 | 近似直线 | 激进拉伸，偏好矩形，拉伸比可达 6.6 |
| `curved` | 0.012 ≤ κ < 0.06 | 一般弯曲 | 中等拉伸，偏好椭圆 |
| `tight` | κ ≥ 0.06 | 急弯/拐角 | 保守拉伸（≤2.0），小尺寸圆形 |

短于 5 个点的碎片段会被合并到前一个段，避免频繁切换图元类型。

### P0-C: 最大内切半径搜索（二分查找）

对于轮廓上的每个停靠点：

1. 计算切线和指向内部的法向量
2. 沿法线方向，二分查找半径 r ∈ [r_min, r_max]
3. 约束条件：圆心 C = P + r·**n**，且 `dist_map[C] ≥ 0.95r`
4. 20 次迭代达到 ~0.3px 精度（vs V2 的线性扫描 O(r_max)）

### P0-D: 图元候选与评分

每个停靠点生成多个候选：

1. **基础圆**：半径 = 最大内切半径，得分 = πr²
2. **拉伸椭圆**：长轴 = r × aspect，短轴 = r，得分 = π·a·b
3. **拉伸矩形**：宽 = 2r·aspect，高 = 2r，得分 = w·h·(1 + bonus)

每个候选都通过 Shapely 做**面积交集检验**：

$$
\frac{\text{Area}(\text{poly} \cap \text{primitive})}{\text{Area}(\text{primitive})} \geq \text{threshold}
$$

threshold = 0.85 (低精度) ~ 1.0 (高精度)。选择得分最高的候选。

### P2-A: 覆盖率检测（渲染法）

不逐点调用 Shapely（O(nm)），而是：

1. 将所有图元用 OpenCV 渲染到二值掩码（O(m)）
2. 膨胀 2px 容许边缘贴合
3. 沿轮廓点密集采样，查掩码像素值（O(n)）

总复杂度 O(n+m)，比逐点几何检测快数个数量级。

### P2-B: 间隙填充

最多 3 轮迭代：
1. 用渲染法检测所有间隙段 (start_arc, end_arc)
2. 在每段间隙中均匀放置补充图元
3. 重新渲染检测 → 如果还有间隙则继续

### P2-C: 图元扩展

遍历所有已放置图元，尝试将长轴/宽度扩大（倍率 1.3 → 1.2 → 1.1），仅在扩展后仍满足包含约束时接受。贪心策略，让图元尽可能大。

---

## 精度参数 (`-p`) 的影响

| 精度 | rect_bonus | aspect_limit | 效果 |
|------|-----------|-------------|------|
| 0.0 | 1.50 | 5.5 | 极致效率：大量矩形+极度拉伸，图元数最少 |
| 0.3 | 1.05 | 4.6 | **默认**：矩形为主，适度拉伸 |
| 0.5 | 0.75 | 4.0 | 均衡：椭圆/矩形各半 |
| 0.8 | 0.30 | 3.1 | 精细：椭圆为主，贴合度高 |
| 1.0 | 0.00 | 2.5 | 极致精度：几乎全椭圆，拉伸保守 |

---

## 依赖

| 库 | 用途 |
|----|------|
| `opencv-python` | 图像读写、Mask 提取、Distance Transform、轮廓提取、渲染 |
| `numpy` | 数值计算、曲率微分 |
| `shapely` | 椭圆/矩形多边形构造、旋转缩放、面积交集包含性检验 |
| `scipy` | 高斯平滑（`gaussian_filter1d`），缺失时回退为均匀平均 |

---

## 文件结构

```
shaper/
├── final_shaper.py          # V3 主程序
├── final_shaper_v2_backup.py # V2 备份
├── gen_test_heart.py         # 测试用爱心图片生成
├── result_A_shapes_only.png  # 输出：纯图元效果图
├── result_B_overlay.png      # 输出：叠加对比图
├── result_C_data.json        # 输出：图元数据 JSON
├── README.md                 # 原始需求文档
└── tech.md                   # 本技术方案文档
```

---

## 后续优化方向

| 优先级 | 方向 | 说明 |
|--------|------|------|
| P1 | Shapely R-tree 空间索引 | 加速相邻图元碰撞检测，处理大图更快 |
| P3 | DiffVG 可微分优化 | 用梯度下降全局优化图元参数，精度更高 |
| — | 三角形图元 | 扩展到三角形，适合尖角区域 |
| — | 填充模式 | 不仅描边，也支持内部填充 |
| — | 3D/2.5D 支持 | 将 2D 图元投射到 3D 表面 |
| — | 颜色匹配 | 根据原图颜色为图元着色 |
